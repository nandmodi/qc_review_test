<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QC Review Dashboard - Block Mode</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f7fa; margin: 0; padding: 0; color: #333; }
    header { background: #0057a3; color: white; padding: 10px 0; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .container { display: flex; justify-content: space-between; padding: 20px; gap: 10px; }
    .image-box { flex: 1; text-align: center; }
    .image-box img { width: 100%; max-height: 600px; object-fit: contain; margin-bottom: 5px; }
    .controls, .login-block { text-align: center; margin: 20px; }
    .status-group { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
    .status-group label { background: #e9f0f7; padding: 10px 20px; border-radius: 6px; cursor: pointer; transition: 0.3s; }
    .status-group input { margin-right: 8px; }
    .status-group label:hover { background: #d0e5f5; }
    button { padding: 12px 25px; background: #0073e6; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #005bb5; }
    iframe { display: none; }
    .progress, .meta { text-align: center; margin-top: 10px; font-size: 1.1rem; }
  </style>
</head>
<body>

<header><h1>QC Review Dashboard - Block Mode</h1></header>

<div class="login-block" id="loginBlock">
  <h2>Login & Select Block</h2>
  <input type="email" id="userEmail" placeholder="Enter your Email ID" style="padding: 10px; width: 250px;"><br><br>
  <select id="blockSelect" style="padding: 10px; width: 260px;"><option value="">-- Select Available Block --</option></select><br><br>
  <button onclick="startSession()">Start QC</button>
  <div id="loginError" style="color:red; margin-top:10px;"></div>
</div>

<div id="userStatus" style="text-align:center; display:none;">
  Logged in as: <strong id="userEmailDisplay"></strong> |
  Block: <strong id="selectedBlockDisplay"></strong>
</div>

<div class="progress" id="progressText" style="display:none;">Loading data...</div>

<div class="container" id="imageContainer" style="display:none;">
  <div class="image-box">
    <h3>Input Image</h3>
    <img id="inputImg" loading="lazy" alt="Input Image">
    <div class="meta">Image ID: <span id="imgId">-</span></div>
  </div>
  <div class="image-box">
    <h3>Output Image</h3>
    <img id="outputImg" loading="lazy" alt="Output Image">
    <div class="meta">SKU ID: <span id="skuId">-</span></div>
  </div>
</div>

<div class="controls" id="controlPanel" style="display:none;">
  <div class="status-group">
    <label><input type="radio" name="status" value="Done">1 - Done</label>
    <label><input type="radio" name="status" value="Cropped">2 - Cropped</label>
    <label><input type="radio" name="status" value="Marketing Material">3 - Marketing Material</label>
    <label><input type="radio" name="status" value="Banner">4 - Banner</label>
    <label><input type="radio" name="status" value="Vehicle Overlapped">5 - Vehicle Overlapped</label>
    <label><input type="radio" name="status" value="Editing">6 - Editing</label>
  </div>
  <button onclick="submitForm()">Next</button>
</div>

<iframe id="hiddenSubmitFrame" name="hiddenSubmitFrame"></iframe>

<script>
  const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRSuUcfgCukw0_2cu7Nvwao_f0zCFW2b8j0-X6WXBGqVjwchwy5jh0lZekk4UIMT53X-XktmlYqbE8r/pub?gid=0&single=true&output=csv";
  const formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSf5UlllmQHY_bFZTndwNStRk47PExlqpCmmCVmZ7E--tDRbpQ/formResponse';
  let loggedInUser = "", selectedBlock = "", fullData = [], blockData = [], currentIndex = 0;

  Papa.parse(csvUrl, {
    download: true,
    header: true,
    complete: function(results) {
      fullData = results.data.filter(r => r.image_id && r.block);
      const blocks = [...new Set(fullData.map(r => r.block))];
      const availableBlocks = blocks.filter(block => {
        const blockRows = fullData.filter(r => r.block === block);
        const reviewed = blockRows.filter(r => r.status && r.status.trim() !== '').length;
        return reviewed < blockRows.length;
      });
      const blockSelect = document.getElementById("blockSelect");
      availableBlocks.forEach(b => {
        const option = document.createElement("option");
        option.value = b;
        option.textContent = b;
        blockSelect.appendChild(option);
      });
    }
  });

  function startSession() {
    const email = document.getElementById("userEmail").value.trim().toLowerCase();
    const block = document.getElementById("blockSelect").value;
    if (!email || !block) return document.getElementById("loginError").innerText = "Please enter email and select a block.";
    loggedInUser = email;
    selectedBlock = block;
    document.getElementById("loginBlock").style.display = "none";
    document.getElementById("userStatus").style.display = "block";
    document.getElementById("userEmailDisplay").innerText = loggedInUser;
    document.getElementById("selectedBlockDisplay").innerText = selectedBlock;
    blockData = fullData.filter(r => r.block === selectedBlock && (!r.status || r.status.trim() === ''));
    if (blockData.length === 0) {
      document.getElementById("progressText").innerText = "âœ… All SKUs in this block are already reviewed.";
    } else {
      document.getElementById("imageContainer").style.display = "flex";
      document.getElementById("controlPanel").style.display = "block";
      showImage();
    }
  }

  function showImage() {
    if (currentIndex >= blockData.length) {
      document.getElementById("progressText").innerText = `ðŸŽ‰ You reviewed ${blockData.length} SKUs!`;
      document.getElementById("imageContainer").style.display = "none";
      document.getElementById("controlPanel").style.display = "none";
      return;
    }
    const row = blockData[currentIndex];
    document.getElementById("inputImg").src = row.input_image_hres_url;
    document.getElementById("outputImg").src = row.output_image_hres_url;
    document.getElementById("imgId").innerText = row.image_id;
    document.getElementById("skuId").innerText = row.sku_id;
    document.getElementById("progressText").innerText = `Reviewed ${currentIndex + 1} of ${blockData.length}`;
  }

  function submitForm() {
    const status = document.querySelector('input[name="status"]:checked');
    if (!status) return alert("Please select a status.");
    const row = blockData[currentIndex];
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = formUrl;
    form.target = 'hiddenSubmitFrame';

    const fields = [
      { name: 'entry.331138758', value: row.image_id },
      { name: 'entry.921407097', value: row.sku_id },
      { name: 'entry.2036611691', value: status.value },
      { name: 'entry.2101228952', value: loggedInUser }
    ];

    fields.forEach(({ name, value }) => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = name;
      input.value = value;
      form.appendChild(input);
    });

    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);

    currentIndex++;
    document.querySelectorAll('input[name="status"]').forEach(el => el.checked = false);
    showImage();
  }
</script>

</body>
</html>
