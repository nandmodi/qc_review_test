<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QC Review Dashboard</title>
  <link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/favicon.ico" type="image/x-icon" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f7fa;
      color: #333;
    }

    header {
      background: #0057a3;
      color: white;
      padding: 0;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    header h1 {
      margin: 10px 0;
      font-size: 1.8em;
    }

    .container {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 20px;
      gap: 1px;
    }

    .image-box {
      flex: 1;
      background: none;
      padding: 0;
      border-radius: 0;
      box-shadow: none;
      text-align: center;
    }

    .image-box img {
      width: 100%;
      height: auto;
      max-height: 600px;
      object-fit: contain;
      border: none;
      margin-bottom: 5px;
    }

    .meta {
      font-size: 0.95em;
      color: #666;
    }

    .controls {
      margin: 30px auto;
      text-align: center;
    }

    .status-group {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }

    .status-group label {
      font-size: 1rem;
      background: #e9f0f7;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .status-group input[type="radio"] {
      margin-right: 8px;
    }

    .status-group label:hover {
      background: #d0e5f5;
    }

    button {
      padding: 12px 25px;
      font-size: 1rem;
      background-color: #0073e6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #005bb5;
    }

    .progress {
      text-align: center;
      margin-top: 15px;
      font-size: 1.1rem;
      color: #444;
    }

    iframe {
      display: none;
    }
  </style>
</head>
<body>

<header>
  <h1>Image QC Review Dashboard</h1>
</header>

<div class="progress" id="progressText">Loading data, please wait...</div>

<div class="container" id="imageContainer" style="display: none;">
  <div class="image-box">
    <h3>Input Image</h3>
    <img id="inputImg" loading="lazy" alt="Input Image">
    <div class="meta">Image ID: <span id="imgId">-</span></div>
  </div>
  <div class="image-box">
    <h3>Output Image</h3>
    <img id="outputImg" loading="lazy" alt="Output Image">
    <div class="meta">SKU ID: <span id="skuId">-</span></div>
  </div>
</div>

<div class="controls" id="controlPanel" style="display: none;">
  <div class="status-group">
    <label><input type="radio" name="status" value="Done"> Done (1 / D)</label>
    <label><input type="radio" name="status" value="Rejected"> Rejected (2 / R)</label>
    <label><input type="radio" name="status" value="Editing"> Editing (3 / E)</label>
  </div>
  <button onclick="submitForm()">Next (Enter)</button>
</div>

<iframe id="hiddenSubmitFrame" name="hiddenSubmitFrame"></iframe>

<script>
  const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQc6Bd5VEE067t02ubbCE_rAYzgOEN9ggvB8uH28TQKldJ5qGePkdSQeYbdvpbhl3lwb1yIhAr8685B/pub?gid=0&single=true&output=csv";
  let data = [];
  let currentIndex = 0;

  Papa.parse(csvUrl, {
    download: true,
    header: true,
    complete: function(results) {
      data = results.data.filter(row => {
        const status = (row.status || '').trim().toLowerCase();
        return !["done", "rejected", "editing"].includes(status);
      });

      if (data.length === 0) {
        document.getElementById("progressText").innerText = "âœ… All SKUs are already reviewed. No SKU left.";
        document.getElementById("imageContainer").style.display = "none";
        document.getElementById("controlPanel").style.display = "none";
      } else {
        document.getElementById("imageContainer").style.display = "flex";
        document.getElementById("controlPanel").style.display = "block";
        showImage();
        preloadNextImages();
      }
    }
  });

  function showImage() {
    if (currentIndex >= data.length) {
      document.getElementById("progressText").innerText = `ðŸŽ‰ You reviewed ${data.length} SKUs!`;
      document.getElementById("imageContainer").style.display = "none";
      document.getElementById("controlPanel").style.display = "none";
      return;
    }

    const row = data[currentIndex];
    document.getElementById("inputImg").src = row["input_image_hres_url"];
    document.getElementById("outputImg").src = row["output_image_hres_url"];
    document.getElementById("imgId").innerText = row["image_id"];
    document.getElementById("skuId").innerText = row["sku_id"];
    document.getElementById("progressText").innerText = `Reviewed ${currentIndex + 1} of ${data.length}`;
    preloadNextImages();
  }

  function submitForm() {
    const status = document.querySelector('input[name="status"]:checked');
    if (!status) return alert("Please select a status.");

    const row = data[currentIndex];
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = 'https://docs.google.com/forms/d/e/1FAIpQLSfAcGmJXwfrNV1xLUHNEYGRw7I4ErTNH5n6GhUltxDcAH008w/formResponse';
    form.target = 'hiddenSubmitFrame';

    const fields = [
      { name: 'entry.331138758', value: row["image_id"] },
      { name: 'entry.921407097', value: row["sku_id"] },
      { name: 'entry.2036611691', value: status.value }
    ];

    fields.forEach(({ name, value }) => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = name;
      input.value = value;
      form.appendChild(input);
    });

    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);

    currentIndex++;
    showImage();
    document.querySelectorAll('input[name="status"]').forEach(el => el.checked = false);
  }

  function preloadNextImages() {
    for (let i = 1; i <= 3; i++) {
      if (currentIndex + i < data.length) {
        const nextRow = data[currentIndex + i];
        new Image().src = nextRow["input_image_hres_url"];
        new Image().src = nextRow["output_image_hres_url"];
      }
    }
  }

  document.addEventListener("keydown", function(event) {
    const key = event.key.toLowerCase();
    const code = event.code;

    if (key === "1" || key === "d" || code === "Numpad1") {
      document.querySelector('input[value="Done"]').checked = true;
    } else if (key === "2" || key === "r" || code === "Numpad2") {
      document.querySelector('input[value="Rejected"]').checked = true;
    } else if (key === "3" || key === "e" || code === "Numpad3") {
      document.querySelector('input[value="Editing"]').checked = true;
    } else if (key === "enter") {
      event.preventDefault();
      submitForm();
    }
  });
</script>

</body>
</html>
