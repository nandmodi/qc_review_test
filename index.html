<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QC Form Submit</title>
  <link rel="icon" href="https://spyne-prod-ai.s3.us-east-1.amazonaws.com/ai-dataset/2025/favicon.ico" type="image/x-icon" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial; text-align: center; margin: 0; padding: 0; }
    .container { display: flex; height: 80vh; }
    .image-box {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      border: 1px solid #000; padding: 10px;
    }
    img { max-width: 100%; max-height: 80%; }
    .controls { margin: 20px; }
    .status-group { margin-top: 20px; }
    iframe { display: none; }
    .meta { margin-top: 10px; font-size: 14px; color: #555; }
    .progress { font-weight: bold; margin: 10px; }
    button { padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>

<h2>Image QC Review</h2>
<div class="progress" id="progressText">Loading...</div>

<div class="container">
  <div class="image-box">
    <div><strong>Input Image</strong></div>
    <img id="inputImg" src="" alt="Input Image">
    <div class="meta">Image ID: <span id="imgId">-</span></div>
  </div>
  <div class="image-box">
    <div><strong>Output Image</strong></div>
    <img id="outputImg" src="" alt="Output Image">
    <div class="meta">SKU ID: <span id="skuId">-</span></div>
  </div>
</div>

<div class="controls">
  <div class="status-group">
    <label><input type="radio" name="status" value="Done"> Done</label>
    <label><input type="radio" name="status" value="Rejected"> Rejected</label>
    <label><input type="radio" name="status" value="Editing"> Editing</label>
  </div>
  <br>
  <button onclick="submitForm()">Next</button>
</div>

<iframe id="hiddenSubmitFrame" name="hiddenSubmitFrame"></iframe>

<script>
  // ✅ Your CSV data link
  const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQc6Bd5VEE067t02ubbCE_rAYzgOEN9ggvB8uH28TQKldJ5qGePkdSQeYbdvpbhl3lwb1yIhAr8685B/pub?gid=0&single=true&output=csv";

  // ✅ Your form response URL (not prefill — this is /formResponse)
  const formBaseURL = "https://docs.google.com/forms/d/e/1FAIpQLSfAcGmJXwfrNV1xLUHNEYGRw7I4ErTNH5n6GhUltxDcAH008w/formResponse";

  // ✅ Your entry field mappings from Google Form
  const entries = {
    image_id: "entry.331138758",
    sku_id: "entry.921407097",
    status: "entry.2036611691"
  };

  let data = [];
  let currentIndex = 0;

  // ✅ Load CSV and filter out reviewed rows
  Papa.parse(csvUrl, {
    download: true,
    header: true,
    complete: function(results) {
      const allRows = results.data;

      // Filter: only rows without valid 'status'
      data = allRows.filter(row => {
        const allowed = ["done", "rejected", "editing"];
        const rawStatus = row.status;
        const status = (rawStatus && !rawStatus.startsWith("#")) ? rawStatus.trim().toLowerCase() : "";
        return !allowed.includes(status);
      });

      showImage();
    }
  });

  // ✅ Show current image + metadata
  function showImage() {
    const total = data.length;
    if (currentIndex < total) {
      const row = data[currentIndex];
      document.getElementById("inputImg").src = row["input_image_hres_url"];
      document.getElementById("outputImg").src = row["output_image_hres_url"];
      document.getElementById("imgId").innerText = row["image_id"];
      document.getElementById("skuId").innerText = row["sku_id"];
      document.getElementById("progressText").innerText = `Reviewed ${currentIndex + 1} of ${total}`;
    } else {
      document.getElementById("progressText").innerText = "✅ Review complete!";
      document.getElementById("inputImg").src = "";
      document.getElementById("outputImg").src = "";
      document.getElementById("imgId").innerText = "-";
      document.getElementById("skuId").innerText = "-";
    }
  }

  // ✅ Read selected radio button value
  function getStatus() {
    const radios = document.getElementsByName("status");
    for (let r of radios) {
      if (r.checked) return r.value;
    }
    return null;
  }

  // ✅ Submit status to Google Form via iframe, then move to next
  function submitForm() {
    const status = getStatus();
    if (!status) {
      alert("Please select a status.");
      return;
    }

    const row = data[currentIndex];

    const formParams = new URLSearchParams();
    formParams.append(entries.image_id, row.image_id);
    formParams.append(entries.sku_id, row.sku_id);
    formParams.append(entries.status, status);

    const formAction = `${formBaseURL}?${formParams.toString()}`;
    document.getElementById("hiddenSubmitFrame").src = formAction;

    setTimeout(() => {
      currentIndex++;
      showImage();
      clearStatus();
    }, 2000);
  }

  function clearStatus() {
    document.querySelectorAll("input[name='status']").forEach(el => el.checked = false);
  }
</script>

</body>
</html>
